services:

  traefik:
    image: traefik:v2.11
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    command:
      - "--providers.docker=true"
      - "--providers.docker.network=association_web"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.myresolver.acme.httpchallenge=true"
      - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.myresolver.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
      - "--providers.file.filename=/traefik/dynamic.yml"
      - "--api.dashboard=true"
      - "--api.insecure=false"
      - "--accesslog=true"
      - "--log.level=INFO"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${ODOO_DOMAIN:-localhost}`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=dashboard-auth@file"
    ports:
      - "127.0.0.1:8888:8080"
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./traefik/acme.json:/letsencrypt/acme.json"
      - "./traefik/dynamic.yml:/traefik/dynamic.yml:ro"
    networks:
      - web

  odoo:
    image: odoo:17.0
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    depends_on:
      - odoo-db
    ports:
      - "8069:8069"
      - "8072:8072"
    environment:
      - HOST=odoo-db
      - USER=${ODOO_DB_USER}
      - PASSWORD=${ODOO_DB_PASSWORD}
    volumes:
      - odoo-data:/var/lib/odoo
      - ./odoo-custom-addons:/mnt/extra-addons
    networks:
      - internal
      - web

  odoo-web:
    image: nginx:stable
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
      - /var/log/nginx
    depends_on:
      - odoo
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.odoo.rule=Host(`${ODOO_DOMAIN}`)"
      - "traefik.http.routers.odoo.entrypoints=web"
      - "traefik.http.services.odoo.loadbalancer.server.port=80"
    ports:
      - "8080:80"
    volumes:
      - ./nginx-odoo.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - web
      - internal

  odoo-db:
    image: postgres:16
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${ODOO_DB_USER}
      - POSTGRES_PASSWORD=${ODOO_DB_PASSWORD}
      - POSTGRES_DB=postgres
    volumes:
      - odoo-postgres-data:/var/lib/postgresql/data
    networks:
      - internal

  payment-api:
    build: ./payment-api
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    depends_on:
      - payments-db
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.payment-api.rule=Host(`${API_DOMAIN}`)"
      - "traefik.http.routers.payment-api.entrypoints=web"
      - "traefik.http.services.payment-api.loadbalancer.server.port=3000"
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - PAYMENT_DB_HOST=payments-db
      - PAYMENT_DB_PORT=5432
      - PAYMENT_DB_USER=${PAYMENTS_DB_USER}
      - PAYMENT_DB_PASSWORD=${PAYMENTS_DB_PASSWORD}
      - PAYMENT_DB_NAME=${PAYMENTS_DB_NAME}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - FLW_SECRET_KEY=${FLW_SECRET_KEY}
      - FLW_WEBHOOK_SECRET=${FLW_WEBHOOK_SECRET}
      - GOCARDLESS_ACCESS_TOKEN=${GOCARDLESS_ACCESS_TOKEN}
      - GOCARDLESS_ENV=${GOCARDLESS_ENV}
      - GOCARDLESS_WEBHOOK_SECRET=${GOCARDLESS_WEBHOOK_SECRET}
      - BASE_URL=https://${API_DOMAIN}
      - ODOO_WEBHOOK_URL=${ODOO_WEBHOOK_URL}
      - ODOO_WEBHOOK_TOKEN=${ODOO_WEBHOOK_TOKEN}
    networks:
      - web
      - internal

  payments-db:
    image: postgres:16
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=${PAYMENTS_DB_USER}
      - POSTGRES_PASSWORD=${PAYMENTS_DB_PASSWORD}
      - POSTGRES_DB=${PAYMENTS_DB_NAME}
    volumes:
      - payments-postgres-data:/var/lib/postgresql/data
    networks:
      - internal

  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    command: ["start-dev"]
    environment:
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD}
      - KC_PROXY=edge
    ports:
      - "8081:8080"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.keycloak.rule=Host(`${AUTH_DOMAIN}`)"
      - "traefik.http.routers.keycloak.entrypoints=web"
      - "traefik.http.services.keycloak.loadbalancer.server.port=8080"
    networks:
      - web
      - internal

  pgadmin:
    image: dpage/pgadmin4:latest
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD}
      - PGADMIN_CONFIG_SERVER_MODE=False
      - PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED=False
    ports:
      - "5050:80"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pgadmin.rule=Host(`${PGADMIN_DOMAIN}`)"
      - "traefik.http.routers.pgadmin.entrypoints=web"
      - "traefik.http.services.pgadmin.loadbalancer.server.port=80"
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    networks:
      - web
      - internal

  mailserver:
    image: axigen/axigen:latest
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    hostname: mail.${MAIL_DOMAIN:-association.local}
    environment:
      - AXIGEN_ENABLE_WEBMAIL=yes
      - AXIGEN_ENABLE_WEBADMIN=yes
      - AXIGEN_ADMIN_PASSWORD=${MAIL_ADMIN_PASSWORD}
    ports:
      - "25:25"     # SMTP
      - "587:587"   # SMTP submission
      - "465:465"   # SMTPS
      - "143:143"   # IMAP
      - "993:993"   # IMAPS
      - "110:110"   # POP3
      - "995:995"   # POP3S
      - "9000:9000" # WebAdmin
      - "8000:8000" # Webmail
    labels:
      - "traefik.enable=true"
      # Webmail
      - "traefik.http.routers.webmail.rule=Host(`${WEBMAIL_DOMAIN}`)"
      - "traefik.http.routers.webmail.entrypoints=web"
      - "traefik.http.routers.webmail.service=webmail"
      - "traefik.http.services.webmail.loadbalancer.server.port=8000"
      # WebAdmin
      - "traefik.http.routers.mailadmin.rule=Host(`${MAILADMIN_DOMAIN}`)"
      - "traefik.http.routers.mailadmin.entrypoints=web"
      - "traefik.http.routers.mailadmin.service=mailadmin"
      - "traefik.http.services.mailadmin.loadbalancer.server.port=9000"
    volumes:
      - mailserver-data:/var/opt/axigen
      - mailserver-logs:/var/opt/axigen/logs
    networks:
      - web
      - internal

volumes:
  odoo-data:
  odoo-postgres-data:
  payments-postgres-data:
  pgadmin-data:
  mailserver-data:
  mailserver-logs:

networks:
  web:
  internal:
